#!/bin/bash

# Importing the settings defined by the user.
g4sp4rz1nh0_PATH="$(pwd | sed 's/\/functions//')"
TOR_TEMP_FILES="$(grep -E "^TOR_TEMP_FILES=" "${g4sp4rz1nh0_PATH}/configs/tor.cfg" | cut -d "=" -f 2 | sed 's|"||g')"
ACCEPTED_COUNTRIES="$(grep -E "^ACCEPTED_COUNTRIES=" "${g4sp4rz1nh0_PATH}/configs/tor.cfg" | cut -d "=" -f 2 | sed 's|"||g')"
BLACKLIST_COUNTRIES="$(grep -E "^BLACKLIST_COUNTRIES=" "${g4sp4rz1nh0_PATH}/configs/tor.cfg" | cut -d "=" -f 2 | sed 's|"||g')"
COUNTRY_LIST_CONTROLS="$(grep -E "^COUNTRY_LIST_CONTROLS=" "${TOR_TEMP_FILES}/initial_user_settings.txt" | cut -d "=" -f 2 | sed 's|"||g')"
CHANGE_COUNTRY_INTERVAL="$(grep -E "^CHANGE_COUNTRY_INTERVAL=" "${g4sp4rz1nh0_PATH}/configs/tor.cfg" | cut -d "=" -f 2 | sed 's|"||g')"
TOTAL_COUNTRIES_TO_CHANGE="$(grep -E "^TOTAL_COUNTRIES_TO_CHANGE=" "${g4sp4rz1nh0_PATH}/configs/tor.cfg" | cut -d "=" -f 2 | sed 's|"||g')"
TORPATH="$(command -v tor)"
HIDDEN_SERVICE_PATH="$(grep -E "^HIDDEN_SERVICE_PATH=" "${g4sp4rz1nh0_PATH}/configs/tor.cfg" | awk -F'=' '{print $2}' | sed 's/"//g')"
USER_ID=$(id | cut -d ")" -f 1 | cut -d "(" -f 2)

if [ -s "${TOR_TEMP_FILES}/current_country_list.txt" ]; then
    cp "${TOR_TEMP_FILES}/current_country_list.txt" "${TOR_TEMP_FILES}/used_country_list.txt"
else
    echo "It will not be possible to change countries as the ${TOR_TEMP_FILES}/current_country_list.txt was not created."
    echo "Run \"bash g4sp4rz1nh0 --kill\" to kill this execution."
    exit 1
fi

sleep "${CHANGE_COUNTRY_INTERVAL}"

# This function will select a random contry from the list of available countries, 
# but will not repeat one of those current countries ${TOR_TEMP_FILES}/current_country_list.txt
select_next_country(){
    if [ -n "${AVAILABLE_COUNTRIES}" ]; then
    	NEXT_COUNTRY="$(echo "${AVAILABLE_COUNTRIES}" | sort -R | head -n 1)"
        # If the NEXT_COUNTRY was not found in the current list of countries
	    if ! grep -q -i "${NEXT_COUNTRY}" "${TOR_TEMP_FILES}/current_country_list.txt" 2> /dev/null; then
		    CURRENT_COUNTRIES="$(sed "s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g" "${TOR_TEMP_FILES}/current_country_list.txt")"
    		echo "${CURRENT_COUNTRIES}" > "${TOR_TEMP_FILES}/current_country_list.txt"
	    else
            # Call this same function again
    	    select_next_country
	    fi
    else
        echo "The variable \${AVAILABLE_COUNTRIES} is empty."
        echo "Please check what happened!"
        exit 1
    fi
}

change_country_on_the_fly(){
	
	# _PID,INSTANCE,COUNTRY,CFG_FILE
	TARGET_INSTANCE_REQUESTED="$1"
	TOR_CURRENT_INSTANCE="${TARGET_INSTANCE_REQUESTED}"
	COUNTRY_TARGET="$(grep -i ",${TARGET_INSTANCE_REQUESTED}," "${TOR_TEMP_FILES}/instances_running_list.txt" | awk -F',' '{print $3}')"
	
	# Generate the list of countries available based on the list of accepted countries
	# but removing from this list the countries that has been used.
    AVAILABLE_COUNTRIES="$(sed "s/,/\n/g" <<< ${ACCEPTED_COUNTRIES})"
	while read -r country_line; do
		AVAILABLE_COUNTRIES_TMP="$(grep -iv "${country_line}" <<< "${AVAILABLE_COUNTRIES}")"
		AVAILABLE_COUNTRIES="${AVAILABLE_COUNTRIES_TMP}"
	done < "${TOR_TEMP_FILES}/used_country_list.txt"
	unset AVAILABLE_COUNTRIES_TMP
	
	echo "${AVAILABLE_COUNTRIES}" > "${TOR_TEMP_FILES}/available_countries.txt"
	# Check if the list of AVAILABLE COUNTRIES is not EMPTY. It means that all countries
	# has been used and we need to restart the listed based on the ACCEPTED COUNTRIES.
	if [ -n "${AVAILABLE_COUNTRIES}" ]; then
        # Call the function
		select_next_country
		# Updating the file ${TOR_TEMP_FILES}/current_country_list.txt
		# This file holds the current list of countries running.
		# The script checks this file to avoid select same country in this list for the next country.
		echo "sed s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g ${TOR_TEMP_FILES}/current_country_list.txt"
		CURRENT_COUNTRIES="$(sed "s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g" "${TOR_TEMP_FILES}/current_country_list.txt")"
		echo "${CURRENT_COUNTRIES}" > "${TOR_TEMP_FILES}/current_country_list.txt"
		# Updating the file ${TOR_TEMP_FILES}/instances_running_list.txt
		# This file holds the current status of the instances.
		INSTANCES_RUNNING_LIST_TMP="$(sed "s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g" "${TOR_TEMP_FILES}/instances_running_list.txt")"
		echo "${INSTANCES_RUNNING_LIST_TMP}" > "${TOR_TEMP_FILES}/instances_running_list.txt"
	else 
        # If all countries available has been used. Update the list removing the current countries.
		cp "${TOR_TEMP_FILES}/current_country_list.txt" "${TOR_TEMP_FILES}/used_country_list.txt"
		# Updating the list of AVAILABLE_COUNTRIES, but removing form this list the current countries.
        AVAILABLE_COUNTRIES="$(sed "s/,/\n/g" <<< ${ACCEPTED_COUNTRIES})"
		while read -r country_line; do
			AVAILABLE_COUNTRIES_TMP="$(grep -iv "${country_line}" <<< "${AVAILABLE_COUNTRIES}")"
			AVAILABLE_COUNTRIES="${AVAILABLE_COUNTRIES_TMP}"
		done < "${TOR_TEMP_FILES}/used_country_list.txt"
		unset AVAILABLE_COUNTRIES_TMP
        # Call the function
		select_next_country
		# Updating the file ${TOR_TEMP_FILES}/current_country_list.txt
		# This file holds the current list of countries running.
		# The script checks this file to avoid select same country in this list for the next country.
		echo "sed s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g ${TOR_TEMP_FILES}/current_country_list.txt"
		CURRENT_COUNTRIES="$(sed "s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g" "${TOR_TEMP_FILES}/current_country_list.txt")"
		echo "${CURRENT_COUNTRIES}" > "${TOR_TEMP_FILES}/current_country_list.txt"
		# Updating the file ${TOR_TEMP_FILES}/instances_running_list.txt
		# This file holds the current status of the instances.
		echo "sed s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g ${TOR_TEMP_FILES}/instances_running_list.txt"
		INSTANCES_RUNNING_LIST_TMP="$(sed "s|${COUNTRY_TARGET}|${NEXT_COUNTRY}|g" "${TOR_TEMP_FILES}/instances_running_list.txt")"
		echo "${INSTANCES_RUNNING_LIST_TMP}" > "${TOR_TEMP_FILES}/instances_running_list.txt"
	fi
	
	if [ -n "${NEXT_COUNTRY}" ]; then
		# Including the next country to the list of used_countries
		echo "${NEXT_COUNTRY}" >> "${TOR_TEMP_FILES}/used_country_list.txt"
		
		# Rewriting the config file of the target instances.
		# After rewrite the script will restart this instances forcing it to read and apply the new configuration.
        if [ -n ${TOR_CURRENT_INSTANCE} ]; then
            for new_instance in ${TOR_CURRENT_INSTANCE}; do
			    # _PID,INSTANCE,COUNTRY,CFG_FILE_
                PID_TARGET="$(grep ",${TOR_CURRENT_INSTANCE}," "${TOR_TEMP_FILES}/instances_running_list.txt" | awk -F',' '{print $1}' | sed 's/_//')"
                CONFIG_TARGET="$(grep ",${TOR_CURRENT_INSTANCE}," "${TOR_TEMP_FILES}/instances_running_list.txt" | awk -F',' '{print $4}')"
                CONFIG_TARGET_TMP="${TOR_TEMP_FILES}/temp_config_tor_${TOR_CURRENT_INSTANCE}.tmp"
			    # Generating the new Tor Configuration file
        		if grep -Evi "EntryNodes|ExitNodes|ExcludeNodes" "${CONFIG_TARGET}" > "${CONFIG_TARGET_TMP}"; then
            	    # entry
	            	if [ "${COUNTRY_LIST_CONTROLS}" = "entry" ]; then
		            	echo "EntryNodes ${NEXT_COUNTRY}" >> "${CONFIG_TARGET_TMP}"
                        echo "ExitNodes $(sed "s/${NEXT_COUNTRY},//" <<< ${ACCEPTED_COUNTRIES})" >> "${CONFIG_TARGET_TMP}"
				        echo "ExcludeNodes ${BLACKLIST_COUNTRIES}" >> "${CONFIG_TARGET_TMP}"
            		fi
	            	# exit
		            if [ "${COUNTRY_LIST_CONTROLS}" = "exit" ]; then
                        echo "EntryNodes $(sed "s/${NEXT_COUNTRY},//" <<< ${ACCEPTED_COUNTRIES})" >> "${CONFIG_TARGET_TMP}"
				        echo "ExitNodes ${NEXT_COUNTRY}" >> "${CONFIG_TARGET_TMP}"
    				    echo "ExcludeNodes ${BLACKLIST_COUNTRIES}" >> "${CONFIG_TARGET_TMP}"
        	    	fi
	        	    # speed
		        	if [ "${COUNTRY_LIST_CONTROLS}" = "speed" ]; then
			            echo "EntryNodes ${NEXT_COUNTRY}" >> "${CONFIG_TARGET_TMP}"
    			      	echo "ExitNodes ${NEXT_COUNTRY}" >> "${CONFIG_TARGET_TMP}"
                        echo "ExcludeNodes ${BLACKLIST_COUNTRIES},$(sed "s/${NEXT_COUNTRY},//" <<< ${ACCEPTED_COUNTRIES})" >> "${CONFIG_TARGET_TMP}"
        		    fi
                else
                    echo "Did not possible create a new TOR configuration file!"
                    exit 1
                fi

        		# Kill the target instance process.
	        	if kill -9 "${PID_TARGET}"; then
    	        	mv "${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}/tor_expect.exp" "${TOR_TEMP_FILES}/tor_expect.exp" > /dev/null 2>&1
	    	        if [ -d "${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}" ]; then
		    	        rm -rf "${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}/" > /dev/null 2>&1
                        if mkdir -p "${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}/" > /dev/null 2>&1; then
                            # Get new config for new instance
            				mv "${CONFIG_TARGET_TMP}" "${CONFIG_TARGET}" > /dev/null 2>&1
    	      	        	mv "${TOR_TEMP_FILES}/tor_expect.exp" \
                                "${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}/tor_expect.exp" > /dev/null 2>&1
		        	        chown -R "${USER_ID}" "${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}" > /dev/null 2>&1
			    	        chmod 700 -R "${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}" > /dev/null 2>&1
                        else
                            echo "Did not possible create the directory ${TOR_TEMP_FILES}/tor${TOR_CURRENT_INSTANCE}!"
                            exit 1
                        fi
			        fi

        			if [ -d "${HIDDEN_SERVICE_PATH}${TOR_CURRENT_INSTANCE}" ]; then
	        		    rm -rf "${HIDDEN_SERVICE_PATH}${TOR_CURRENT_INSTANCE}/" > /dev/null 2>&1
                        if mkdir -p "${HIDDEN_SERVICE_PATH}${TOR_CURRENT_INSTANCE}" > /dev/null 2>&1; then
	    	        	    chown -R "${USER_ID}" "${HIDDEN_SERVICE_PATH}${TOR_CURRENT_INSTANCE}"
		    	        	chmod 700 -R "${HIDDEN_SERVICE_PATH}${TOR_CURRENT_INSTANCE}"
                        fi
    			    fi
                else
                    echo "Did not possible to kill the instance ${TOR_CURRENT_INSTANCE} process ${PID_TARGET}!"
                    exit 1
                fi
			
        		# There is a chain of dependencies here:
	        	# 1) Execute the tor instance with the new configuration and put it in the background
        		# 2) Remove the current from the file instances_running_list.txt
		        # 3) Update the instances_running_list.txt with the new information about the TOR Instance. 
        		"${TORPATH}" -f "${CONFIG_TARGET}" > /dev/null 2>&1
		        if sed -i "\|${CONFIG_TARGET}|d" "${TOR_TEMP_FILES}/instances_running_list.txt"; then
                    sleep 2
                    echo "_$(cat "${TOR_TEMP_FILES}"/tor"${TOR_CURRENT_INSTANCE}"/tor"${TOR_CURRENT_INSTANCE}".pid),${TOR_CURRENT_INSTANCE},${NEXT_COUNTRY},${CONFIG_TARGET}" >> "${TOR_TEMP_FILES}/instances_running_list.txt"
                fi
            done
        else
            echo "Did not possible to get the value of \"\${TOR_CURRENT_INSTANCE}\"!"
            exit 1
        fi
    else
        echo "next country vazio"
        exit 1
    fi
}

if ! touch "${TOR_TEMP_FILES}/changed_instances.txt"; then
    echo "Didn't possible create ${TOR_TEMP_FILES}/changed_instances.txt file."
    echo "Run \"bash g4sp4rz1nh0 --kill\" to kill this execution."
    exit 1
else
    ALL_INSTANCES="$(grep -v "^#" "${TOR_TEMP_FILES}/instances_running_list.txt" | awk -F',' '{print $2}' | sort -R)"
    TOTAL_INSTANCES=$(grep -v "^#" "${TOR_TEMP_FILES}/instances_running_list.txt" | awk -F',' '{print $2}' | wc -l)
    echo "${ALL_INSTANCES}" > "${TOR_TEMP_FILES}/pending_instances.txt" 
    while :; do
	    seq 1 "${TOTAL_COUNTRIES_TO_CHANGE}" > "${TOR_TEMP_FILES}/loop_instances_to_change.txt"
    	while read -r count; do
            TOTAL_CHANGED=$(wc -l "${TOR_TEMP_FILES}/changed_instances.txt" | awk '{print $1}')
            if [ ${TOTAL_CHANGED} -eq ${TOTAL_INSTANCES} ] ; then
                > "${TOR_TEMP_FILES}/changed_instances.txt"
                echo "${ALL_INSTANCES}" > "${TOR_TEMP_FILES}/pending_instances.txt"
            fi
            RANDOM_INSTANCE=$(cat "${TOR_TEMP_FILES}/pending_instances.txt" | sort -R | head -n 1)
            # If the RANDOM_NUMBER was not found in the current list of instances running
            if ! grep -q -i -E "^${RANDOM_INSTANCE}$" "${TOR_TEMP_FILES}/changed_instances.txt" 2> /dev/null; then
                # If the RANDOM_NUMBER is not the same number of the previous instance changed.
	    		if [ -n "${RANDOM_INSTANCE}" ]; then 
		    	    echo "${RANDOM_INSTANCE}" >> "${TOR_TEMP_FILES}/changed_instances.txt"
                    sed -i "/^${RANDOM_INSTANCE}$/d" "${TOR_TEMP_FILES}/pending_instances.txt"
                    # Call the function
					change_country_on_the_fly "${RANDOM_INSTANCE}"
    			fi
	    	fi	
	    done < "${TOR_TEMP_FILES}/loop_instances_to_change.txt"
    	sleep "$(shuf -i1-"${CHANGE_COUNTRY_INTERVAL}" -n1)"
    done
fi
